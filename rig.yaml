---
- hosts: rig
  remote_user: loic
  become: yes
  vars:
    nas_disk_uuid: "6111e246-08d1-46c2-9ae5-2ebf89c22986"
  tasks:
    - name: Delete root password
      command: passwd -d root

    - name: Disallow password authentication
      lineinfile: 
        dest: /etc/ssh/sshd_config
        regexp: "^#PasswordAuthentication yes"
        line: "PasswordAuthentication no"
        backrefs: yes
      notify: Restart ssh

    - name: Disallow root SSH access
      lineinfile: 
        dest: /etc/ssh/sshd_config
        regexp: "^#PermitRootLogin yes"
        line: "PermitRootLogin no"
        backrefs: yes
      notify: Restart ssh

    - name: disable SELinux
      lineinfile: 
        dest: /etc/selinux/config
        regexp: "^SELINUX="
        line: "SELINUX=disabled"
        backrefs: yes
    
    - name: configure fstab and mount nas disk
      mount: 
        src: UUID={{ nas_disk_uuid }}
        path: /mnt/nas #is created if needed
        fstype: btrfs 
        state: mounted
        passno: 2
    
    - name: upgrade all packages
      yum: name=* state=latest

    - name: install common packages
      yum: 
        name: "{{ packages }}"
        state: latest
      vars:
        packages:
          - epel-release
          - tmux 
          - htop 
          - yum-utils 
          - unzip
          - curl
          - wget
          - bash-completion
          - duplicity
    
    - name: reboot (required by SELinux desactivation)
      reboot:

  handlers:
    - name: Restart ssh
      shell: sleep 3; /etc/init.d/sshd restart
      async: 1
      poll: 0
